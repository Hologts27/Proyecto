<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub - Catálogo de Películas y Series</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="var(--primary-bg)">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Inline styles removed, relying on style.css and classes like .page-subheader, .page-container, .dash-nav-grid, .dash-nav-item -->
  <script>
    // Service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { // Changed from just navigator.serviceWorker.register
        navigator.serviceWorker.register('sw.js').catch(err => console.error('Service Worker registration failed:', err));
      });
    }
  </script>
</head>
<body>

  <header class="page-subheader">
    <div class="page-container">
        <h1><i class="material-icons" style="vertical-align: middle; margin-right: 8px; font-size: 2.2rem;">dashboard</i>Dashboard</h1>
        <button id="logoutButton" class="btn btn-secondary">
            <i class="material-icons" style="vertical-align: middle; margin-right: 4px;">logout</i>Cerrar Sesión
        </button>
    </div>
  </header>

  <main class="page-container" style="padding-top: 2rem; padding-bottom: 2rem;">
    <h2 id="welcomeMessage" style="text-align: center; margin-bottom: 2.5rem; color: var(--heading-text);">
      Bienvenido, <span id="usuario-nombre" style="color: var(--accent-color); font-weight: bold;"></span>
    </h2>

    <nav class="dash-nav-grid">
      <a href="peliculas.html" class="dash-nav-item">
        <i class="material-icons dash-nav-icon">movie</i>
        <h3>Películas</h3>
        <p>Explora el catálogo de películas.</p>
      </a>
      <a href="series.html" class="dash-nav-item">
        <i class="material-icons dash-nav-icon">tv</i>
        <h3>Series</h3>
        <p>Descubre nuevas series.</p>
      </a>
      <a href="favoritos.html" class="dash-nav-item">
        <i class="material-icons dash-nav-icon">favorite</i>
        <h3>Favoritos</h3>
        <p>Accede a tus títulos preferidos.</p>
      </a>
      <a href="guardados.html" class="dash-nav-item">
        <i class="material-icons dash-nav-icon">bookmark</i>
        <h3>Guardados</h3>
        <p>Ve tu lista de "ver más tarde".</p>
      </a>
       <a href="todo.html" class="dash-nav-item">
        <i class="material-icons dash-nav-icon">list_alt</i>
        <h3>To-Do List</h3>
        <p>Organiza tus tareas pendientes.</p>
      </a>
      <a href="manage.html" class="dash-nav-item">
        <i class="material-icons dash-nav-icon">manage_accounts</i>
        <h3>Gestionar Cuenta</h3>
        <p>Actualiza tu perfil y contraseña.</p>
      </a>
      <!-- Admin link container - JS will handle display -->
      <div id="admin-link-container" class="dash-nav-item-wrapper" style="display: none;">
        <a href="admin.html" class="dash-nav-item">
          <i class="material-icons dash-nav-icon">admin_panel_settings</i>
          <h3>Panel Admin</h3>
          <p>Gestionar usuarios y sistema.</p>
        </a>
      </div>
    </nav>
  </main>

  <footer class="page-footer">
    <div class="page-container">
      <p>© 2024 Catálogo App. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Toast container is styled globally by style.css if #toast-container is used by JS -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
    const token = localStorage.getItem("jwt");

    // User verification and welcome message
    if (!loggedInUser || !loggedInUser.username) {
      window.location.href = "index.html";
    } else {
      const userNameSpan = document.getElementById('usuario-nombre');
      if(userNameSpan) userNameSpan.textContent = loggedInUser.username;
    }

    // Admin link visibility
    if (loggedInUser && loggedInUser.role === 'admin') {
      const adminLinkContainer = document.getElementById('admin-link-container');
      if(adminLinkContainer) adminLinkContainer.style.display = 'block';
    }

    // Logout functionality
    const logoutButton = document.getElementById('logoutButton');
    if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          const confirmLogout = confirm("¿Seguro que quieres cerrar sesión?");
          if (confirmLogout) {
            if (token) {
                try {
                    const response = await fetch('http://localhost:3001/logout', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        console.warn('Logout API call failed, proceeding with client-side logout.');
                    }
                } catch (error) {
                    console.warn('Error calling logout API:', error, 'Proceeding with client-side logout.');
                }
            }
            localStorage.removeItem("loggedInUser");
            localStorage.removeItem("jwt");
            localStorage.removeItem("adminToken"); // Important for admin users
            window.location.href = "index.html";
          }
        });
    } else {
        console.error("Logout button not found.");
    }

    // Toast notification system (if needed on this page, otherwise can be removed)
    // Ensure #toast-container div exists if using toasts here.
    function showToast(message, type = 'info', duration = 3500) {
      const container = document.getElementById('toast-container');
      if (!container) { // Create container if it doesn't exist
          const newContainer = document.createElement('div');
          newContainer.id = 'toast-container';
          document.body.appendChild(newContainer);
          container = newContainer;
      }
      const toast = document.createElement('div');
      toast.className = `toast ${type}`; // These classes should be in style.css
      toast.textContent = message;
      container.appendChild(toast);

      // Animation is handled by CSS, remove JS animation for opacity/transform
      setTimeout(() => {
          toast.style.animation = 'fadeOutToast 0.4s forwards'; // Use CSS animation for fade out
          toast.addEventListener('animationend', (e) => {
              if(e.animationName === 'fadeOutToast') { // Check if it's the correct animation
                toast.remove();
              }
          }, { once: true }); // Ensure listener is removed after execution
      }, duration);
    }

    // Safe fetch wrapper (if needed on this page, otherwise can be removed)
    // async function safeFetch(url, options = {}) { ... } // Defined in other files, can be global if needed
  </script>

</body>
</html>
