<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TODO | Cat√°logo</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212">
  <link rel="stylesheet" href="style.css"> <!-- General styles -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
  <style>
    /* General Body Styles */
    body {
      background-color: #121212;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Main Container */
    .main-container {
      background: #1e1e1e; /* Darker background for the container */
      padding: 25px 40px; /* Adjusted padding */
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5); /* Softer shadow */
      width: 90%;
      max-width: 700px; /* Slightly wider for better content fit */
      margin: 40px auto; /* More margin for centering */
    }

    /* Heading */
    h1 {
      text-align: center;
      color: #e50914; /* Netflix-like red */
      margin-bottom: 30px; /* More space below heading */
      font-size: 2.5rem; /* Larger heading */
    }

    /* Form Styling */
    #addTaskForm {
      margin-bottom: 30px; /* More space below form */
      display: flex;
      flex-direction: column;
      gap: 15px; /* Space between form elements */
    }

    label {
      display: block;
      margin-bottom: 8px; /* More space for label */
      color: #ccc;
      font-weight: bold; /* Make labels bolder */
    }

    input[type="text"],
    textarea {
      width: calc(100% - 24px); /* Full width minus padding */
      padding: 12px; /* More padding */
      margin-bottom: 10px; /* Consistent margin */
      border-radius: 6px; /* Slightly more rounded */
      border: 1px solid #444; /* Darker border */
      background-color: #2c2c2c; /* Slightly lighter input background */
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input[type="text"]:focus,
    textarea:focus {
        border-color: #e50914;
        box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.3);
        outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 80px; /* Taller textarea */
    }

    button[type="submit"]#addTaskBtn {
      background-color: #e50914;
      color: white;
      padding: 12px 20px; /* More padding */
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem; /* Larger font */
      font-weight: bold;
      transition: background-color 0.2s ease, transform 0.1s ease;
      align-self: flex-start; /* Align button to the start if form is flex */
    }
    button[type="submit"]#addTaskBtn:hover {
      background-color: #b20710; /* Darker on hover */
      transform: translateY(-1px); /* Slight lift on hover */
    }
    button[type="submit"]#addTaskBtn:active {
        transform: translateY(0px); /* Press down effect */
    }

    /* Task List Styling */
    #taskList {
      list-style: none;
      padding: 0;
    }

    #taskList li {
      background-color: #282828; /* Slightly lighter item background */
      padding: 15px 20px; /* More padding */
      margin-bottom: 12px; /* More space between items */
      border-radius: 8px; /* More rounded items */
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease, opacity 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    #taskList li:hover {
        transform: translateY(-2px); /* Lift item on hover */
        box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    #taskList li .task-details {
      flex-grow: 1;
      margin-right: 15px; /* More space before actions */
    }

    #taskList li .task-title {
      font-size: 1.2rem; /* Larger title */
      color: #f0f0f0; /* Lighter title color */
      font-weight: 500;
      transition: color 0.3s ease;
    }

    #taskList li .task-description {
      font-size: 0.95rem; /* Slightly larger description */
      color: #b0b0b0; /* Lighter description color */
      margin-top: 6px;
      white-space: pre-wrap;
      word-break: break-word;
      transition: color 0.3s ease;
    }

    /* Task Actions (Checkbox and Delete Button) */
    #taskList li .task-actions {
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    #taskList li input[type="checkbox"].complete-checkbox {
      margin-right: 15px;
      cursor: pointer;
      width: 20px;
      height: 20px;
      accent-color: #e50914; /* Style checkbox color */
    }
    /* Custom checkbox appearance (optional, more complex) */
    /* Consider if simple accent-color is enough */

    #taskList li .delete-btn {
      background-color: #505050; /* Neutral delete button */
      color: white;
      border: none;
      padding: 8px 12px; /* Balanced padding */
      border-radius: 5px; /* Consistent rounding */
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    #taskList li .delete-btn:hover {
      background-color: #c0392b; /* Red on hover for delete */
      transform: scale(1.05); /* Slight zoom on hover */
    }
    #taskList li .delete-btn:active {
        transform: scale(0.98);
    }

    /* Completed Task Styling */
    #taskList li.completed {
        background-color: #333; /* Darker background for completed */
        /* opacity: 0.7; /* Optional: slightly fade out completed tasks */
    }
    #taskList li.completed .task-title {
      text-decoration: line-through;
      color: #888;
    }
    #taskList li.completed .task-description {
      color: #777;
    }

    /* Error Message Styling */
    .error-message {
      color: #ff5252; /* Brighter red for errors */
      background-color: rgba(255, 82, 82, 0.1); /* Slight background for error */
      text-align: center;
      margin-top: 20px;
      padding: 10px; /* Padding for error message */
      border-radius: 6px; /* Rounded corners for error message */
      min-height: 1.2em;
      border: 1px solid rgba(255, 82, 82, 0.3);
    }

    /* "No Tasks" Message Styling */
    .no-tasks-message {
        text-align: center;
        color: #aaa;
        padding: 20px; /* More padding */
        font-style: italic; /* Italicize message */
    }

    /* Basic Responsive Adjustments */
    @media (max-width: 768px) {
      .main-container {
        width: 95%;
        padding: 20px;
        margin-top: 20px;
      }
      h1 {
        font-size: 2rem;
      }
      #taskList li {
        padding: 12px 15px;
      }
      #taskList li .task-title {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .main-container {
        padding: 15px;
      }
      input[type="text"],
      textarea,
      button[type="submit"]#addTaskBtn {
        font-size: 0.95rem; /* Adjust font size for smaller screens */
        padding: 10px;
      }
      #taskList li {
        flex-direction: column; /* Stack elements vertically on very small screens */
        align-items: flex-start; /* Align to start */
      }
      #taskList li .task-actions {
        margin-top: 10px; /* Add space above actions when stacked */
        width: 100%; /* Make actions take full width */
        justify-content: flex-end; /* Align actions to the right */
      }
      #taskList li input[type="checkbox"].complete-checkbox {
        margin-right: auto; /* Push checkbox to left, delete to right */
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <h1>My To-Do List</h1>

    <form id="addTaskForm">
      <div>
        <label for="taskTitleInput">Task Title:</label>
        <input type="text" id="taskTitleInput" required>
      </div>
      <div>
        <label for="taskDescriptionInput">Task Description (Optional):</label>
        <textarea id="taskDescriptionInput"></textarea>
      </div>
      <button type="submit" id="addTaskBtn">Add Task</button>
    </form>

    <ul id="taskList">
      <!-- Task items will be added here by JavaScript -->
      <li style="display: none;" class="task-item-template" id="taskItemTemplate">
        <div class="task-details">
          <span class="task-title">Sample Task Title</span>
          <p class="task-description">This is a sample task description.</p>
        </div>
        <div class="task-actions">
          <input type="checkbox" class="complete-checkbox" aria-label="Mark task as complete">
          <button class="delete-btn">Delete</button>
        </div>
      </li>
    </ul>
    <div id="errorMessage" class="error-message" style="display: none;"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loggedInUserString = localStorage.getItem('loggedInUser');
      let userId = null;

      if (loggedInUserString) {
        try {
          const loggedInUser = JSON.parse(loggedInUserString);
          if (loggedInUser && loggedInUser.id) {
            userId = loggedInUser.id;
          }
        } catch (e) {
          console.error('Error parsing loggedInUser from localStorage:', e);
        }
      }

      const errorMessageDiv = document.getElementById('errorMessage');

      function displayError(message) {
        errorMessageDiv.textContent = message;
        errorMessageDiv.style.display = 'block';
      }

      function clearError() {
        errorMessageDiv.textContent = '';
        errorMessageDiv.style.display = 'none';
      }

      if (!userId) {
        console.error('User ID not found. Redirecting to login.');
        displayError('Error: User not logged in. Please login to view your tasks.');
        // window.location.href = 'login.html'; // Optional: redirect
        return;
      }

      const token = localStorage.getItem('jwt');
      if (!token) {
        console.error('JWT token not found. Redirecting to login.');
        displayError('Error: Authentication token not found. Please login again.');
        // window.location.href = 'login.html'; // Optional: redirect
        return;
      }

      const taskListUL = document.getElementById('taskList');
      const taskItemTemplate = document.getElementById('taskItemTemplate');
      const addTaskForm = document.getElementById('addTaskForm');
      const taskTitleInput = document.getElementById('taskTitleInput');
      const taskDescriptionInput = document.getElementById('taskDescriptionInput');

      function displayNoTasksMessage() {
        if (taskListUL.querySelector('.no-tasks-message')) return;

        const noTasksMessageP = document.createElement('p');
        noTasksMessageP.textContent = 'No tasks found. Add some!';
        noTasksMessageP.classList.add('no-tasks-message');
        taskListUL.appendChild(noTasksMessageP);
      }

      function removeNoTasksMessage() {
        const existingMsg = taskListUL.querySelector('.no-tasks-message');
        if (existingMsg) {
            existingMsg.remove();
        }
      }

      async function fetchAndDisplayTasks(currentUserId) {
        try {
          const response = await fetch(`/todo?user_id=${currentUserId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const tasks = await response.json();
            taskListUL.innerHTML = '';

            if (!taskListUL.contains(taskItemTemplate) && taskItemTemplate) {
                 taskListUL.appendChild(taskItemTemplate);
            }
            if (taskItemTemplate) taskItemTemplate.style.display = 'none';


            if (!taskItemTemplate) {
                console.error('Task item template not found!');
                displayError('Error: Page setup incomplete. Cannot display tasks.');
                return;
            }

            clearError();

            if (tasks.length === 0) {
                displayNoTasksMessage();
            } else {
                removeNoTasksMessage();
                tasks.forEach(task => {
                  const listItem = taskItemTemplate.cloneNode(true);
                  listItem.removeAttribute('id');
                  listItem.style.display = 'flex';
                  listItem.dataset.id = task.id;

                  const titleSpan = listItem.querySelector('.task-title');
                  const descriptionP = listItem.querySelector('.task-description');
                  const checkbox = listItem.querySelector('.complete-checkbox');

                  if (titleSpan) titleSpan.textContent = task.titulo;
                  if (descriptionP) {
                    descriptionP.textContent = task.descripcion || '';
                    if (!task.descripcion) {
                        descriptionP.style.display = 'none';
                    } else {
                        descriptionP.style.display = 'block';
                    }
                  }
                  if (checkbox) checkbox.checked = !!task.completado;

                  if (task.completado) {
                    listItem.classList.add('completed');
                  } else {
                    listItem.classList.remove('completed');
                  }

                  taskListUL.appendChild(listItem);
                });
            }
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Failed to fetch tasks and parse error.' }));
            console.error('Failed to fetch tasks:', response.status, errorData.error);
            displayError(`Error fetching tasks: ${errorData.error || response.statusText}`);
          }
        } catch (error) {
          console.error('Error during fetchAndDisplayTasks:', error);
          displayError('An unexpected error occurred while fetching tasks.');
        }
      }

      if (addTaskForm) {
        addTaskForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          clearError();

          const taskTitle = taskTitleInput.value.trim();
          const taskDescription = taskDescriptionInput.value.trim();

          if (!userId || !token) {
            console.error('User ID or token missing for add task.');
            displayError('Authentication error. Please log in again.');
            return;
          }

          if (!taskTitle) {
            displayError('Task title cannot be empty.');
            return;
          }

          const taskObject = {
            user_id: userId,
            titulo: taskTitle,
            descripcion: taskDescription
          };

          try {
            const response = await fetch('/todo', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(taskObject)
            });

            if (response.ok) {
              taskTitleInput.value = '';
              taskDescriptionInput.value = '';
              fetchAndDisplayTasks(userId);
            } else {
              const errorData = await response.json().catch(() => ({ error: 'Failed to add task and parse error response.' }));
              console.error('Failed to add task:', response.status, errorData.error);
              displayError(`Error adding task: ${errorData.error || response.statusText}`);
            }
          } catch (error) {
            console.error('Error during addTask:', error);
            displayError('An unexpected error occurred while adding the task.');
          }
        });
      } else {
        console.error('Add task form not found!');
        displayError('Error: Page setup incomplete. Cannot add tasks.');
      }

      if (taskListUL) {
        // Event delegation for checkbox changes
        taskListUL.addEventListener('change', async (event) => {
          if (event.target.classList.contains('complete-checkbox')) {
            clearError();
            const checkbox = event.target;
            const listItem = checkbox.closest('li');
            const taskId = listItem.dataset.id;
            const newCompletionStatus = checkbox.checked;

            if (!userId || !token) {
              console.error('User ID or token missing for update task.');
              displayError('Authentication error. Please log in again.');
              checkbox.checked = !newCompletionStatus;
              return;
            }
            if (!taskId) {
                console.error('Task ID not found on list item.');
                displayError('Error: Could not identify the task to update.');
                checkbox.checked = !newCompletionStatus;
                return;
            }

            const currentTitleElem = listItem.querySelector('.task-title');
            const currentDescriptionElem = listItem.querySelector('.task-description');

            const taskUpdateObject = {
              titulo: currentTitleElem ? currentTitleElem.textContent : '',
              descripcion: currentDescriptionElem ? currentDescriptionElem.textContent : '',
              completado: newCompletionStatus
            };

            try {
              const response = await fetch(`/todo/${taskId}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(taskUpdateObject)
              });

              if (response.ok) {
                listItem.classList.toggle('completed', newCompletionStatus);
              } else {
                const errorData = await response.json().catch(() => ({ error: 'Failed to update task and parse error response.' }));
                console.error('Failed to update task:', response.status, errorData.error);
                displayError(`Error updating task: ${errorData.error || response.statusText}`);
                checkbox.checked = !newCompletionStatus;
              }
            } catch (error) {
              console.error('Error during updateTask:', error);
              displayError('An unexpected error occurred while updating the task.');
              checkbox.checked = !newCompletionStatus;
            }
          }
        });

        // Event delegation for delete button clicks
        taskListUL.addEventListener('click', async (event) => {
          if (event.target.classList.contains('delete-btn')) {
            clearError();
            const deleteButton = event.target;
            const listItem = deleteButton.closest('li');
            const taskId = listItem.dataset.id;

            if (!userId || !token) {
              console.error('User ID or token missing for delete task.');
              displayError('Authentication error. Please log in again.');
              return;
            }
            if (!taskId) {
                console.error('Task ID not found on list item for delete.');
                displayError('Error: Could not identify the task to delete.');
                return;
            }

            if (!confirm('Are you sure you want to delete this task?')) {
              return;
            }

            try {
              const response = await fetch(`/todo/${taskId}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });

              if (response.ok) {
                listItem.style.opacity = '0';
                setTimeout(() => {
                    listItem.remove();
                    if (taskListUL.querySelectorAll('li:not(#taskItemTemplate):not([style*="display: none"])').length === 0) {
                        displayNoTasksMessage();
                    }
                }, 300);
              } else {
                const errorData = await response.json().catch(() => ({ error: 'Failed to delete task and parse error response.' }));
                console.error('Failed to delete task:', response.status, errorData.error);
                displayError(`Error deleting task: ${errorData.error || response.statusText}`);
              }
            } catch (error) {
              console.error('Error during deleteTask:', error);
              displayError('An unexpected error occurred while deleting the task.');
            }
          }
        });
      }


      fetchAndDisplayTasks(userId);
    });
  </script>
</body>
</html>
