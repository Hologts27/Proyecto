<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestionar Cuenta | Catálogo App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818"> <!-- Hardcoded theme color -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* Targeted inline styles for manage.html specific structure */
    body.page-body-flex-center { /* To center the card on the page */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Align card to top, header will push down */
        min-height: 100vh;
        padding-top: 2rem; /* Space from top if header wasn't fixed */
        padding-bottom: 2rem; /* Space for footer */
    }
    .manage-account-card {
      background-color: var(--card-bg);
      padding: var(--card-padding-y) var(--card-padding-x);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border-color);
      width: 100%;
      max-width: 550px; /* Max width for the form card */
      margin-top: 1rem; /* Space below subheader if not using full page-container for main */
    }
    .manage-account-card h2 { /* Specific heading for sections within this card */
        font-size: 1.5rem;
        color: var(--accent-color);
        margin-bottom: 1.25rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .form-section {
        margin-bottom: 2rem;
    }
    .form-section:last-of-type {
        margin-bottom: 1rem;
    }
    /* Inputs, labels, buttons will use global styles from style.css */
    /* .status-message styling is global in style.css */
     .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal-backdrop.active {
      display: flex;
      opacity: 1;
    }
    .modal-dialog {
      background-color: var(--card-bg);
      padding: var(--card-padding-y) var(--card-padding-x);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      min-width: 320px;
      max-width: 90%;
      width: 400px;
      transform: scale(0.95);
      transition: transform 0.3s ease-in-out;
    }
    .modal-backdrop.active .modal-dialog {
        transform: scale(1);
    }
    .modal-dialog h3 {
      color: var(--accent-color);
      margin-top: 0;
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 1.5rem;
    }
    .modal-dialog .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }
  </style>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => console.error('SW reg failed: ', err));
      });
    }
  </script>
</head>
<body class="page-body-flex-center">

  <header class="page-subheader">
    <div class="page-container">
        <h1><i class="material-icons" style="vertical-align: middle; margin-right: 8px;">manage_accounts</i> Gestionar Cuenta</h1>
        <nav>
            <a href="dash.html" class="btn btn-secondary"><i class="material-icons" style="vertical-align: middle; margin-right: 4px;">arrow_back</i> Volver al Hub</a>
            <button id="logoutButtonManage" class="btn btn-secondary"><i class="material-icons" style="vertical-align: middle; margin-right: 4px;">logout</i> Cerrar Sesión</button>
        </nav>
    </div>
  </header>

  <main class="page-container" style="width:100%; display:flex; flex-direction:column; align-items:center;"> <!-- Ensure main container also helps centering -->
    <div class="manage-account-card">
      <p style="text-align:center; margin-bottom:1.5rem;">Usuario: <strong id="usuario-nombre" style="color:var(--accent-color);"></strong></p>

      <div id="message" class="status-message" role="alert" aria-live="assertive"></div>

      <section class="form-section">
        <h2><i class="material-icons" style="vertical-align: middle; margin-right: 8px;">email</i>Cambiar Correo Electrónico</h2>
        <div class="form-group">
          <label for="nuevoCorreo">Nuevo Correo:</label>
          <input type="email" id="nuevoCorreo" placeholder="Ingresa tu nuevo correo" />
        </div>
        <button class="btn btn-primary" onclick="cambiarCorreo()">
            <i class="material-icons">send</i> Actualizar Correo
        </button>
      </section>

      <hr style="border: none; height: 1px; background-color: var(--border-color); margin: 2rem 0;">

      <section class="form-section">
        <h2><i class="material-icons" style="vertical-align: middle; margin-right: 8px;">password</i>Cambiar Contraseña</h2>
        <div class="form-group">
          <label for="actualContra">Contraseña Actual:</label>
          <input type="password" id="actualContra" placeholder="Tu contraseña actual" />
        </div>
        <div class="form-group">
          <label for="nuevaContra">Nueva Contraseña:</label>
          <input type="password" id="nuevaContra" placeholder="Mín. 8 caracteres, mayús., núm., símb." />
        </div>
        <div class="form-group">
          <label for="confirmarContra">Confirmar Nueva Contraseña:</label>
          <input type="password" id="confirmarContra" placeholder="Repite la nueva contraseña" />
        </div>
        <button class="btn btn-primary" onclick="cambiarContraseña()">
            <i class="material-icons">key</i> Cambiar Contraseña
        </button>
      </section>
    </div>

    <!-- Modal de confirmación para cambio de contraseña -->
    <div id="modal-confirm-bg" class="modal-backdrop">
      <div class="modal-dialog">
        <h3 id="modal-confirm-title">Confirmar Acción</h3> <!-- Generic title -->
        <p id="modal-confirm-msg" style="color:var(--primary-text); margin-bottom:1rem;">¿Estás seguro?</p>
        <div class="modal-actions">
          <button class="btn btn-secondary modal-confirm-btn cancel" id="modal-confirm-no">Cancelar</button>
          <button class="btn btn-primary modal-confirm-btn confirm" id="modal-confirm-yes">Confirmar</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="page-footer">
    <div class="page-container">
        <p>&copy; 2024 Catálogo App. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Toast container is global from style.css, can be used by showToast if needed -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    const jwt = localStorage.getItem('jwt');
    if (!jwt) {
      // Allow access if only changing password and not requiring old one, but API protects
      // For now, keeping strict check. If user is here, they should be logged in.
      // window.location.href = 'login.html';
    }

    const messageDiv = document.getElementById("message");
    function displayLocalMessage(msg, type = 'error') {
        if (messageDiv) {
            messageDiv.textContent = msg;
            messageDiv.className = 'status-message ' + type;
        }
    }

    // Global showToast function (from style.css related JS, or should be in a global script)
    // For now, including a basic version if not present globally.
    if (typeof showToast !== 'function') {
        window.showToast = function(message, type = 'info', duration = 3500) {
            const container = document.getElementById('toast-container') || document.body;
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                document.body.appendChild(toastContainer);
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            toast.style.animation = 'slideInToast 0.4s forwards';
            setTimeout(() => {
                toast.style.animation = 'fadeOutToast 0.4s forwards';
                toast.addEventListener('animationend', (e) => {
                    if (e.animationName === 'fadeOutToast') toast.remove();
                }, { once: true });
            }, duration);
        }
    }


    async function safeFetch(url, options = {}) {
      options.headers = { ...options.headers, 'Authorization': `Bearer ${jwt}` };
      if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
          options.headers['Content-Type'] = 'application/json';
          options.body = JSON.stringify(options.body);
      }
      try {
        const res = await fetch(url, options);
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || `Error ${res.status}`);
        }
        return data;
      } catch (err) {
        // Use displayLocalMessage for form-specific feedback, showToast for general errors
        displayLocalMessage(err.message || 'Error de conexión con el servidor.', 'error');
        throw err; // Re-throw for specific catch blocks if needed
      }
    }

    const usuario = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!usuario || !usuario.id) {
      alert("No se encontró información de usuario. Redirigiendo a login.");
      window.location.href = "login.html";
    } else {
      const userNameSpan = document.getElementById("usuario-nombre");
      if(userNameSpan) userNameSpan.textContent = usuario.username;
    }

    async function cambiarCorreo() {
      displayLocalMessage('', 'error'); // Clear previous
      const nuevoCorreo = document.getElementById("nuevoCorreo").value.trim();
      if (!nuevoCorreo || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(nuevoCorreo)) { // Basic email format check
        displayLocalMessage("Ingresa un correo electrónico válido.", "error");
        return;
      }
      try {
        const data = await safeFetch('http://localhost:3001/update_email', {
          method: 'POST',
          body: { user_id: usuario.id, email: nuevoCorreo }
        });
        if (data.ok) {
          displayLocalMessage("Correo actualizado correctamente. Es posible que necesites verificarlo.", "success");
          document.getElementById("nuevoCorreo").value = "";
          // Update local storage if email is stored there
          const updatedUser = {...usuario, email: nuevoCorreo };
          localStorage.setItem("loggedInUser", JSON.stringify(updatedUser));
          document.getElementById("usuario-nombre").textContent = updatedUser.username; // Refresh display if username changes with email
        } else {
          // safeFetch throws an error, so this else might not be reached if error parsing is robust
          displayLocalMessage(data.error || "Error al actualizar correo.", "error");
        }
      } catch (err) { /* message already shown by safeFetch */ }
    }

    function validarSeguridad(contra) {
      const minLargo = contra.length >= 8;
      const mayus = /[A-Z]/.test(contra);
      const numero = /[0-9]/.test(contra);
      const simbolo = /[^A-Za-z0-9]/.test(contra);
      return minLargo && mayus && numero && simbolo;
    }

    function showConfirmModal(title, msg, onConfirm) {
      const bg = document.getElementById('modal-confirm-bg');
      const titleElem = document.getElementById('modal-confirm-title'); // Assuming you add this ID
      const msgDiv = document.getElementById('modal-confirm-msg');

      if(titleElem) titleElem.textContent = title;
      msgDiv.textContent = msg;
      bg.style.display = 'flex'; // Show modal
      setTimeout(() => bg.classList.add('active'), 10); // Trigger transition

      function close() {
        bg.classList.remove('active');
        setTimeout(() => bg.style.display = 'none', 300); // Wait for transition
        yesBtn.removeEventListener('click', confirmHandler);
        noBtn.removeEventListener('click', cancelHandler);
      }
      const yesBtn = document.getElementById('modal-confirm-yes');
      const noBtn = document.getElementById('modal-confirm-no');
      function confirmHandler() { close(); onConfirm(); }
      function cancelHandler() { close(); }
      yesBtn.addEventListener('click', confirmHandler, { once: true });
      noBtn.addEventListener('click', cancelHandler, { once: true });
    }

    async function cambiarContraseña() {
      displayLocalMessage('', 'error'); // Clear previous
      const actual = document.getElementById("actualContra").value;
      const nueva = document.getElementById("nuevaContra").value;
      const confirmar = document.getElementById("confirmarContra").value;

      if (!actual || !nueva || !confirmar) {
        displayLocalMessage("Por favor, completa todos los campos de contraseña.", "error");
        return;
      }
      if (nueva !== confirmar) {
        displayLocalMessage("La nueva contraseña y su confirmación no coinciden.", "error");
        return;
      }
      if (!validarSeguridad(nueva)) {
        displayLocalMessage("Contraseña no segura: Mín. 8 caracteres, una mayúscula, un número y un símbolo.", "error");
        return;
      }

      showConfirmModal('Confirmar Cambio de Contraseña', '¿Estás seguro de que deseas cambiar tu contraseña?', async () => {
        try {
          const data = await safeFetch('http://localhost:3001/update_password', {
            method: 'POST',
            body: { user_id: usuario.id, old_password: actual, new_password: nueva }
          });
          if (data.ok) {
            displayLocalMessage("Contraseña actualizada correctamente.", "success");
            document.getElementById("actualContra").value = "";
            document.getElementById("nuevaContra").value = "";
            document.getElementById("confirmarContra").value = "";
          } else {
             // This part might not be reached if safeFetch throws and handles error display
            displayLocalMessage(data.error || "Error al actualizar contraseña.", "error");
          }
        } catch (err) { /* message already shown by safeFetch */ }
      });
    }

    const logoutButtonManage = document.getElementById('logoutButtonManage');
    if (logoutButtonManage) {
        logoutButtonManage.addEventListener('click', async () => {
            const confirmLogout = confirm("¿Seguro que quieres cerrar sesión?");
            if (confirmLogout) {
                const currentToken = localStorage.getItem('jwt');
                if (currentToken) {
                    try {
                        await fetch('/logout', {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + currentToken }
                        });
                    } catch (err) { console.error('Logout API call failed:', err); }
                }
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('jwt');
                localStorage.removeItem('adminToken');
                window.location.href = 'index.html';
            }
        });
    }
  </script>
</body>
</html>
