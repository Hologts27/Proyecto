<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ver más tarde - Catálogo</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="var(--primary-bg)">
  <link rel="stylesheet" href="style.css"> <!-- Ensure this is present -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
  <!-- Inline styles removed. Styles will be sourced from style.css -->
</head>
<body>

  <header class="page-subheader">
    <div class="page-container">
      <h1>⏰ Ver más tarde</h1>
      <nav>
        <a href="dash.html" class="btn btn-secondary">Volver al Hub</a>
        <button id="logout-btn" class="btn btn-secondary" style="margin-left: 0.5rem;">Cerrar sesión</button>
      </nav>
    </div>
  </header>

  <main class="page-container">
    <div class="media-grid-container" id="guardados-container">
      <!--
        IMPORTANT JAVASCRIPT MODIFICATION NOTE:
        The JavaScript in this file (loadGuardados function)
        currently generates an OLD HTML structure for saved items.
        It needs to be updated to generate the NEW .media-card structure,
        as defined in style.css and the task description. For example:
        <div class="media-card" data-id="[id]" data-type="[tipo]">
            <img src="[poster_url]" alt="[Title]" class="media-card-poster">
            <div class="media-card-body">
                <h3 class="media-card-title">[Title]</h3>
                <p class="media-card-info">[Type: Movie/Serie]</p>
                <div class="media-card-actions">
                    <button class="btn btn-remove-saved">Quitar</button>
                </div>
            </div>
        </div>
        Event listeners for the remove button must also be re-attached.
      -->
      <p class="text-muted" style="text-align:center;">Cargando lista de "Ver más tarde"...</p>
    </div>
  </main>

  <footer class="page-footer">
    <div class="page-container">
      <p>© 2024 Catálogo Cine & Series. Todos los derechos reservados.</p>
    </div>
  </footer>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Existing JavaScript from guardados.html ( 그대로 유지 ) -->
  <!-- NOTE: THIS SCRIPT SECTION IS UNCHANGED AND STILL GENERATES OLD CARD HTML -->
  <script>
    // JWT y usuario robusto
    const token = localStorage.getItem('jwt');
    // Script from guardados.html, to be modified for new card structure and event handling
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

    if (!token || !loggedInUser || !loggedInUser.id) {
      alert('Usuario no autenticado. Redirigiendo a login.');
      window.location.href = 'login.html';
    }

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            if (confirm("¿Seguro que quieres cerrar sesión?")) {
                if (token) {
                    try {
                        await fetch('http://localhost:3001/logout', {
                            method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
                        });
                    } catch (e) { console.warn('Logout API call failed', e); }
                }
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('jwt');
                localStorage.removeItem('adminToken');
                window.location.href = 'index.html';
            }
        });
    }

    const guardadosContainer = document.getElementById('guardados-container');

    function showToast(message, type = 'info', duration = 3500) {
      const container = document.getElementById('toast-container');
      if (!container) {
          console.warn("Toast container not found!");
          return;
      }
      const toast = document.createElement('div');
      toast.className = `toast ${type}`; // Assumes global toast styles are present
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeOutToast 0.4s forwards';
        toast.addEventListener('animationend', () => toast.remove());
      }, duration);
    }

    async function safeFetch(url, options = {}) {
      options.headers = options.headers || {};
      if (url.startsWith('http://localhost:3001')) { // Only add Auth for local API calls
          options.headers['Authorization'] = `Bearer ${token}`;
      }
      try {
        const res = await fetch(url, options);
        if (!res.ok) {
          let errMsg = `Error ${res.status}`;
          try {
            const data = await res.json();
            errMsg = data.error || errMsg;
          } catch {}
          throw new Error(errMsg);
        }
        return await res.json();
      } catch (err) {
        showToast(err.message || 'Error de conexión con el servidor.', 'error');
        throw err; // Re-throw to allow calling function to handle UI updates if needed
      }
    }

    function displayNoItemsMessage() {
        if (!guardadosContainer.querySelector('.media-card')) { // Check if any cards are left
            guardadosContainer.innerHTML = '<p class="text-muted" style="text-align:center; grid-column: 1 / -1;">No tienes títulos guardados para ver más tarde.</p>';
        }
    }

    async function loadGuardados() {
      guardadosContainer.innerHTML = '<p class="text-muted" style="text-align:center;">Cargando...</p>';
      let guardadosSeries = [];
      let guardadosPeliculas = [];
      try {
        const resSeries = await safeFetch(`http://localhost:3001/guardados?user_id=${loggedInUser.id}`);
        guardadosSeries = resSeries || [];
      } catch (e) { /* safeFetch already shows toast */ }
      try {
        const resPeliculas = await safeFetch(`http://localhost:3001/guardados_peliculas?user_id=${loggedInUser.id}`);
        guardadosPeliculas = resPeliculas || [];
      } catch (e) { /* safeFetch already shows toast */ }

      const guardados = [...guardadosSeries, ...guardadosPeliculas];

      if (!guardados.length) {
        displayNoItemsMessage();
        return;
      }
      guardadosContainer.innerHTML = ''; // Clear before appending new cards

      guardados.forEach(item => {
        const itemType = item.title ? 'movie' : 'tv';
        const title = item.title || item.name;
        const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
        const year = item.release_date ? item.release_date.substring(0, 4) : (item.first_air_date ? item.first_air_date.substring(0, 4) : 'N/A');
        const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
        const description = item.overview || '';
        const shortDescription = description.length > 80 ? description.substring(0, 80) + '...' : description; // Shorter for cards

        const cardHTML = `
            <div class="media-card" data-id="${item.id}" data-type="${itemType}">
                <img src="${posterPath}" alt="${title}" class="media-card-poster" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x750.png?text=No+Image';">
                <div class="media-card-body">
                    <h3 class="media-card-title">${title}</h3>
                    <p class="media-card-info">${year} | Tipo: ${itemType === 'movie' ? 'Película' : 'Serie'}</p>
                    <p class="media-card-overview">${shortDescription}</p>
                    <div class="media-card-actions">
                        <button class="btn btn-remove" data-action="removeSaved">
                            <i class="material-icons">delete_outline</i> Quitar
                        </button>
                        <button class="btn btn-details" data-action="showDetails">
                            <i class="material-icons">info</i> Detalles
                        </button>
                    </div>
                </div>
            </div>
        `;
        guardadosContainer.insertAdjacentHTML('beforeend', cardHTML);
      });
    }

    guardadosContainer.addEventListener('click', async function(event) {
        const button = event.target.closest('button.btn');
        if (!button) return;

        const card = event.target.closest('.media-card');
        if (!card) return;

        const itemId = parseInt(card.dataset.id);
        const itemType = card.dataset.type;
        const action = button.dataset.action;
        const title = card.querySelector('.media-card-title').textContent;

        if (action === 'removeSaved') {
            if (confirm(`¿Seguro que deseas quitar "${title}" de esta lista?`)) {
                await quitarGuardado(itemId, itemType, card);
            }
        } else if (action === 'showDetails') {
            // This page doesn't have a modal, redirect or show basic info
            alert(`Detalles para ${itemType} ID: ${itemId}\nTítulo: ${title}`);
            // Potentially redirect to peliculas.html or series.html with query params
            // Or, implement a shared modal logic if required for future tasks.
        }
    });

    async function quitarGuardado(itemId, tipo, cardElement) {
      const endpoint = tipo === 'movie' ? 'guardados_peliculas' : 'guardados';
      const idField = tipo === 'movie' ? 'pelicula_id' : 'serie_id';
      try {
        await safeFetch(`http://localhost:3001/${endpoint}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: loggedInUser.id, [idField]: itemId })
        });
        showToast(`"${cardElement.querySelector('.media-card-title').textContent}" eliminado de guardados.`, 'success');
        cardElement.remove();
        displayNoItemsMessage();
      } catch (e) {
        // Error already shown by safeFetch, but you could add specific UI updates here if needed
        console.error(`Failed to remove ${tipo} from saved:`, e);
      }
    }

      if (tipo === 'serie') {
        await safeFetch('http://localhost:3001/guardados', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ user_id: loggedInUser.id, serie_id: Number(itemId) })
        });
      } else {
        await safeFetch('http://localhost:3001/guardados_peliculas', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ user_id: loggedInUser.id, pelicula_id: Number(itemId) })
        });
      }
    }
    loadGuardados();
  </script>
</body>
</html>
