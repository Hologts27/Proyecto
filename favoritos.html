<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Favoritos - Catálogo</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="var(--primary-bg)">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
  <!-- Inline styles removed. Styles will be sourced from style.css -->
</head>
<body>

  <header class="page-subheader">
    <div class="page-container">
      <h1>❤️ Tus Favoritos</h1>
      <nav>
        <a href="dash.html" class="btn btn-secondary">Volver al Hub</a>
        <button id="logout-btn" class="btn btn-secondary" style="margin-left: 0.5rem;">Cerrar sesión</button>
      </nav>
    </div>
  </header>

  <main class="page-container">
    <div class="media-grid-container" id="favoritos-container">
      <!--
        IMPORTANT JAVASCRIPT MODIFICATION NOTE:
        The JavaScript in this file (loadFavoritos function)
        currently generates an OLD HTML structure for favorite items.
        It needs to be updated to generate the NEW .media-card structure,
        as defined in style.css and the task description. For example:
        <div class="media-card" data-id="[id]" data-type="[tipo]">
            <img src="[poster_url]" alt="[Title]" class="media-card-poster">
            <div class="media-card-body">
                <h3 class="media-card-title">[Title]</h3>
                <p class="media-card-info">[Type: Movie/Serie]</p>
                <div class="media-card-actions">
                    <button class="btn btn-remove-favorite">Quitar</button>
                </div>
            </div>
        </div>
        Event listeners for the remove button must also be re-attached.
      -->
      <p class="text-muted" style="text-align:center;">Cargando favoritos...</p>
    </div>
  </main>

  <footer class="page-footer">
    <div class="page-container">
      <p>© 2024 Catálogo Cine & Series. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Contenedor para notificaciones Toast -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    // Obtener el token JWT y usuario robusto (igual que peliculas.html y series.html)
    const token = localStorage.getItem('jwt');
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!token) {
      alert('No hay JWT en localStorage');
      localStorage.removeItem('jwt');
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }
    if (!loggedInUser || !loggedInUser.id) {
      alert('No hay usuario en localStorage');
      localStorage.removeItem('jwt');
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'index.html';
    });

    const favoritosContainer = document.getElementById('favoritos-container'); // JS uses this ID

    // Sistema de notificaciones toast
function showToast(message, type = 'info', duration = 3500) {
  const container = document.getElementById('toast-container'); // Ensure this container exists in HTML
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('hide');
    toast.addEventListener('transitionend', () => toast.remove());
  }, duration);
}

// Función fetch segura para manejo de errores
async function safeFetch(url, options = {}) {
  try {
    const res = await fetch(url, options);
    if (!res.ok) {
      let errMsg = `Error ${res.status}`;
      try {
        const data = await res.json();
        errMsg = data.error || errMsg;
      } catch {}
      throw new Error(errMsg);
    }
    return await res.json();
  } catch (err) {
    showToast(err.message || 'Error de conexión con el servidor.', 'error');
    throw err;
  }
}

// Cargar favoritos desde ambas APIs y unirlos
async function loadFavoritos() {
  let favoritosSeries = [];
  let favoritosPeliculas = [];
  try {
    const resSeries = await fetch(`http://localhost:3001/favoritos?user_id=${loggedInUser.id}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    favoritosSeries = await resSeries.json();
  } catch (e) {
    favoritosSeries = [];
  }
  try {
    const resPeliculas = await fetch(`http://localhost:3001/favoritos_peliculas?user_id=${loggedInUser.id}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    favoritosPeliculas = await resPeliculas.json();
  } catch (e) {
    favoritosPeliculas = [];
  }
  const favoritos = [...favoritosSeries, ...favoritosPeliculas];
  if (!favoritos.length) {
    favoritosContainer.innerHTML = '<p class="text-muted" style="text-align:center; grid-column: 1 / -1;">No tienes favoritos.</p>';
    return;
  }
  favoritosContainer.innerHTML = ''; // Clear before appending

  favoritos.forEach(item => {
    const itemType = item.title ? 'movie' : 'tv';
    const title = item.title || item.name;
    const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
    const year = item.release_date ? item.release_date.substring(0, 4) : (item.first_air_date ? item.first_air_date.substring(0, 4) : 'N/A');
    // Rating might not be consistently available in stored favorite data, handle gracefully
    const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
    const description = item.overview || '';
    const shortDescription = description.length > 80 ? description.substring(0, 80) + '...' : description;

    const cardHTML = `
        <div class="media-card" data-id="${item.id}" data-type="${itemType}">
            <img src="${posterPath}" alt="${title}" class="media-card-poster" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x750.png?text=No+Image';">
            <div class="media-card-body">
                <h3 class="media-card-title">${title}</h3>
                <p class="media-card-info">${year} | Tipo: ${itemType === 'movie' ? 'Película' : 'Serie'}</p>
                <p class="media-card-overview">${shortDescription}</p>
                <div class="media-card-actions">
                    <button class="btn btn-remove-favorite" data-action="removeFavorite">
                        <i class="material-icons">favorite</i> Quitar Favorito
                    </button>
                    <button class="btn btn-details" data-action="showDetails">
                        <i class="material-icons">info</i> Detalles
                    </button>
                </div>
            </div>
        </div>
    `;
    favoritosContainer.insertAdjacentHTML('beforeend', cardHTML);
  });
}

// Event Delegation for removing items and showing details
favoritosContainer.addEventListener('click', async function(event) {
    const button = event.target.closest('button.btn');
    if (!button) return;

    const card = event.target.closest('.media-card');
    if (!card) return;

    const itemId = parseInt(card.dataset.id);
    const itemType = card.dataset.type;
    const action = button.dataset.action;
    const title = card.querySelector('.media-card-title').textContent;


    if (action === 'removeFavorite') {
        if (confirm(`¿Seguro que deseas quitar "${title}" de tus favoritos?`)) {
            await quitarFavorito(itemId, itemType, card); // Pass card for direct DOM manipulation
        }
    } else if (action === 'showDetails') {
        // This page doesn't have a modal implemented in the original script.
        // For now, just log or alert.
        alert(`Detalles para ${itemType} ID: ${itemId}\nTítulo: ${title}`);
        // To implement fully, you might redirect to peliculas.html/series.html with a query param
        // or implement a generic modal display logic here.
    }
});

// Función para quitar favorito
async function quitarFavorito(itemId, tipo, cardElement) {
  if (tipo === 'serie') {
    await safeFetch('http://localhost:3001/favoritos', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ user_id: loggedInUser.id, serie_id: Number(itemId) })
    });
  } else {
    await safeFetch('http://localhost:3001/favoritos_peliculas', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ user_id: loggedInUser.id, pelicula_id: Number(itemId) })
    });
  }
}

// Cargar favoritos al iniciar
loadFavoritos();
  </script>
</body>
</html>
